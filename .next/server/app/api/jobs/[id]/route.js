(()=>{var e={};e.id=796,e.ids=[796],e.modules={3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},5486:e=>{"use strict";e.exports=require("bcrypt")},7354:(e,r,t)=>{"use strict";t.r(r),t.d(r,{patchFetch:()=>x,routeModule:()=>f,serverHooks:()=>h,workAsyncStorage:()=>g,workUnitAsyncStorage:()=>j});var s={};t.r(s),t.d(s,{DELETE:()=>b,GET:()=>p});var o=t(96559),n=t(48088),a=t(37719),i=t(32190),u=t(19854),l=t(12909),d=t(31183),c=t(11323);async function p(e){let r=null;try{let t=new URL(e.url).pathname.split("/").pop();if(!t)return i.NextResponse.json({error:"Job ID is required"},{status:400});console.log(`Getting job details for job ID: ${t}`);let s=await (0,u.getServerSession)(l.Nh);if(!s)return console.log("No session found - user not authenticated"),i.NextResponse.json({error:"Unauthorized"},{status:401});let o=s.user.id;if(console.log(`User ID from session: ${o}`),o.startsWith("hardcoded-")){if(console.log(`User is hardcoded, checking memory store for job ${t}`),c.t7.has(t)){console.log(`Found job ${t} in memory store`);let e=c.t7.get(t);if(e&&e.userId!==o)return console.log(`Job ${t} belongs to ${e.userId}, not current user ${o}`),i.NextResponse.json({error:"Unauthorized"},{status:403});if(e){let r=e.totalWebsites||0,t=e.processedWebsites||0,s=r>0?Math.min(100,Math.floor(t/r*100)):0;return i.NextResponse.json({job:{id:e.id,name:e.name,status:e.status,sheetUrl:e.sheetUrl,columnName:e.columnName,createdAt:e.createdAt,updatedAt:e.updatedAt,progress:s,totalUrls:r,processedUrls:t,userId:e.userId},results:e.results||[]})}}else console.log(`Job ${t} not found in memory store for user ${o}`)}console.log(`Fetching job ${t} from database for user ${o}`);try{r=(0,d.b)();let e=await r.job.findUnique({where:{id:t}});if(!e)return console.log(`Job ${t} not found in database`),i.NextResponse.json({error:"Job not found"},{status:404});if(e.userId!==o)return console.log(`Job ${t} belongs to ${e.userId}, not current user ${o}`),i.NextResponse.json({error:"Unauthorized"},{status:403});console.log(`Successfully found job ${t} for user ${o} in database, fetching results...`);let s=await r.result.findMany({where:{jobId:t},orderBy:{createdAt:"asc"}});console.log(`Found ${s.length} results for job ${t}`);let n=e.totalUrls||0,a=s.length,u=n>0?Math.min(100,Math.floor(a/n*100)):0;return i.NextResponse.json({job:{...e,progress:u,totalUrls:n,processedUrls:a},results:s.map(e=>({website:e.website,email:e.email}))})}catch(e){return console.error(`Database error fetching job ${t}:`,e),i.NextResponse.json({error:"Database error fetching job"},{status:500})}finally{r&&await r.$disconnect()}}catch(e){return console.error("Get job error:",e),i.NextResponse.json({error:"Failed to get job"},{status:500})}}async function b(e){let r=null;try{let t=new URL(e.url).pathname.split("/").pop();if(!t)return i.NextResponse.json({error:"Job ID is required"},{status:400});console.log(`Deleting job ID: ${t}`);let s=await (0,u.getServerSession)(l.Nh);if(!s)return console.log("No session found - user not authenticated"),i.NextResponse.json({error:"Unauthorized"},{status:401});let o=s.user.id;if(console.log(`User ID from session: ${o}`),o.startsWith("hardcoded-")){if(console.log(`User is hardcoded, checking memory store for job ${t}`),c.t7.has(t)){let e=c.t7.get(t);if(e&&e.userId!==o)return console.log(`Job ${t} belongs to ${e.userId}, not current user ${o}`),i.NextResponse.json({error:"Unauthorized"},{status:403});if(e){console.log(`Deleting job ${t} from memory store`),c.t7.delete(t);try{r=(0,d.b)();let e=await r.job.findUnique({where:{id:t}});e&&e.userId===o&&(await r.result.deleteMany({where:{jobId:t}}),await r.job.delete({where:{id:t}}),console.log(`Also deleted job ${t} from database`))}catch(e){console.error(`Failed to delete job ${t} from database:`,e)}finally{r&&(await r.$disconnect(),r=null)}return i.NextResponse.json({success:!0})}}else console.log(`Job ${t} not found in memory store for user ${o}`)}console.log(`Attempting to delete job ${t} from database for user ${o}`);try{r=(0,d.b)();let e=await r.job.findUnique({where:{id:t}});if(!e)return console.log(`Job ${t} not found in database`),i.NextResponse.json({error:"Job not found"},{status:404});if(e.userId!==o)return console.log(`Job ${t} belongs to ${e.userId}, not current user ${o}`),i.NextResponse.json({error:"Unauthorized"},{status:403});return console.log(`Deleting results for job ${t}`),await r.result.deleteMany({where:{jobId:t}}),console.log(`Deleting job ${t} from database`),await r.job.delete({where:{id:t}}),i.NextResponse.json({success:!0})}catch(e){return console.error(`Database error deleting job ${t}:`,e),i.NextResponse.json({error:"Database error deleting job"},{status:500})}finally{r&&await r.$disconnect()}}catch(e){return console.error("Delete job error:",e),i.NextResponse.json({error:"Failed to delete job"},{status:500})}}let f=new o.AppRouteRouteModule({definition:{kind:n.RouteKind.APP_ROUTE,page:"/api/jobs/[id]/route",pathname:"/api/jobs/[id]",filename:"route",bundlePath:"app/api/jobs/[id]/route"},resolvedPagePath:"/Users/sankalp/fs2/email-scraper/src/app/api/jobs/[id]/route.ts",nextConfigOutput:"",userland:s}),{workAsyncStorage:g,workUnitAsyncStorage:j,serverHooks:h}=f;function x(){return(0,a.patchFetch)({workAsyncStorage:g,workUnitAsyncStorage:j})}},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},11723:e=>{"use strict";e.exports=require("querystring")},12412:e=>{"use strict";e.exports=require("assert")},28354:e=>{"use strict";e.exports=require("util")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},55511:e=>{"use strict";e.exports=require("crypto")},55591:e=>{"use strict";e.exports=require("https")},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},66541:e=>{"use strict";e.exports=require("@prisma/client/runtime/library")},74075:e=>{"use strict";e.exports=require("zlib")},78335:()=>{},79428:e=>{"use strict";e.exports=require("buffer")},79551:e=>{"use strict";e.exports=require("url")},81630:e=>{"use strict";e.exports=require("http")},94735:e=>{"use strict";e.exports=require("events")},96330:e=>{"use strict";e.exports=require("@prisma/client")},96487:()=>{}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),s=r.X(0,[978,116,190,839],()=>t(7354));module.exports=s})();