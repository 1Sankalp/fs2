(()=>{var e={};e.id=796,e.ids=[796],e.modules={3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},5486:e=>{"use strict";e.exports=require("bcrypt")},7354:(e,r,t)=>{"use strict";t.r(r),t.d(r,{patchFetch:()=>h,routeModule:()=>f,serverHooks:()=>m,workAsyncStorage:()=>g,workUnitAsyncStorage:()=>j});var s={};t.r(s),t.d(s,{DELETE:()=>b,GET:()=>p});var o=t(96559),n=t(48088),a=t(37719),i=t(32190),u=t(19854),l=t(12909),c=t(31183),d=t(11323);async function p(e,{params:r}){let t=null;try{let e=r.id;if(!e)return i.NextResponse.json({error:"Job ID is required"},{status:400});console.log(`Getting job details for job ID: ${e}`);let s=await (0,u.getServerSession)(l.Nh);if(!s)return console.log("No session found - user not authenticated"),i.NextResponse.json({error:"Unauthorized"},{status:401});let o=s.user.id;console.log(`User ID from session: ${o}`);try{if(d.t7.has(e)){console.log(`Found job ${e} in memory store`);let r=d.t7.get(e);if(r&&r.userId!==o)return console.log(`Job ${e} belongs to ${r.userId}, not current user ${o}`),i.NextResponse.json({error:"Unauthorized"},{status:403});if(r){let e=r.totalWebsites||0,t=r.processedWebsites||0,s=e>0?Math.min(100,Math.floor(t/e*100)):0;return i.NextResponse.json({job:{id:r.id,name:r.name,status:r.status,sheetUrl:r.sheetUrl,columnName:r.columnName,createdAt:r.createdAt,updatedAt:r.updatedAt,progress:s,totalUrls:e,processedUrls:t,userId:r.userId},results:r.results||[]})}}}catch(r){console.error(`Error accessing memory store for job ${e}:`,r)}console.log(`Fetching job ${e} from database for user ${o}`);let n=0;for(;n<3;)try{t&&await t.$disconnect().catch(console.error),t=(0,c.b)();let r=await t.job.findUnique({where:{id:e}});if(!r)return console.log(`Job ${e} not found in database`),i.NextResponse.json({error:"Job not found"},{status:404});if(r.userId!==o)return console.log(`Job ${e} belongs to ${r.userId}, not current user ${o}`),i.NextResponse.json({error:"Unauthorized"},{status:403});console.log(`Successfully found job ${e} for user ${o} in database, fetching results...`);let s=await t.result.findMany({where:{jobId:e},orderBy:{createdAt:"asc"}});console.log(`Found ${s.length} results for job ${e}`);let n=r.totalUrls||0,a=s.length,u=n>0?Math.min(100,Math.floor(a/n*100)):0;return i.NextResponse.json({job:{...r,progress:u,totalUrls:n,processedUrls:a},results:s.map(e=>({website:e.website,email:e.email}))})}catch(t){if(n++,console.error(`Database error fetching job ${e} (attempt ${n}/3):`,t),n>=3){try{let r=await (0,d.YQ)(e);if(r&&r.userId===o){console.log(`Using memory job ${e} as database fallback`);let t=r.totalWebsites||0,s=r.processedWebsites||0,o=t>0?Math.min(100,Math.floor(s/t*100)):0;return i.NextResponse.json({job:{id:r.id,name:r.name,status:r.status,sheetUrl:r.sheetUrl,columnName:r.columnName,createdAt:r.createdAt,updatedAt:r.updatedAt,progress:o,totalUrls:t,processedUrls:s,userId:r.userId},results:r.results||[]})}}catch(e){console.error("Memory fallback failed:",e)}return i.NextResponse.json({error:"Database error fetching job",details:"Failed after 3 attempts"},{status:500})}let r=300*Math.pow(2,n);await new Promise(e=>setTimeout(e,r))}}catch(e){return console.error("Get job error:",e),i.NextResponse.json({error:"Failed to get job"},{status:500})}finally{t&&await t.$disconnect().catch(console.error)}}async function b(e,{params:r}){let t=null;try{let e=r.id;if(!e)return console.error("DELETE request missing job ID"),i.NextResponse.json({error:"Job ID is required"},{status:400});console.log(`DELETE request for job ID: ${e}`);let s=await (0,u.getServerSession)(l.Nh);if(!s)return console.log("DELETE request - No session found"),i.NextResponse.json({error:"Unauthorized"},{status:401});let o=s.user.id;console.log(`DELETE request - User ID: ${o}`);try{let r=!1,s=!1;if(d.t7.has(e)){let t=d.t7.get(e);t&&(r=!0,s=t.userId===o,console.log(`Job ${e} found in memory, belongs to user: ${s}`))}if(!r||!s)try{t=(0,c.b)();let n=await t.job.findUnique({where:{id:e},select:{id:!0,userId:!0}});n?(r=!0,s=n.userId===o,console.log(`Job ${e} found in database, belongs to user: ${s}`)):console.log(`Job ${e} not found in database`)}catch(t){if(console.error(`Error checking job ${e} in database:`,t),!r)return i.NextResponse.json({error:"Could not verify job ownership",details:"Database connection error"},{status:500});console.log("Using memory verification only due to database error")}if(!r)return i.NextResponse.json({error:"Job not found"},{status:404});if(!s)return i.NextResponse.json({error:"You do not have permission to delete this job"},{status:403});console.log(`Deleting job ${e} for user ${o}`);try{if(await (0,d.XX)(e))return i.NextResponse.json({success:!0,message:"Job deleted successfully",jobId:e});return console.error(`Failed to delete job ${e}`),i.NextResponse.json({error:"Failed to delete job completely",partialSuccess:!0},{status:500})}catch(r){return console.error(`Error executing deleteJob for ${e}:`,r),i.NextResponse.json({error:"Error deleting job",message:r instanceof Error?r.message:"Unknown error"},{status:500})}}catch(r){return console.error(`Error in DELETE handler for job ${e}:`,r),i.NextResponse.json({error:"Server error deleting job",message:r instanceof Error?r.message:"Unknown error"},{status:500})}finally{t&&await t.$disconnect().catch(console.error)}}catch(e){return console.error("Critical error in DELETE handler:",e),i.NextResponse.json({error:"Critical server error",message:e instanceof Error?e.message:"Unknown error"},{status:500})}}let f=new o.AppRouteRouteModule({definition:{kind:n.RouteKind.APP_ROUTE,page:"/api/jobs/[id]/route",pathname:"/api/jobs/[id]",filename:"route",bundlePath:"app/api/jobs/[id]/route"},resolvedPagePath:"/Users/sankalp/fs2/email-scraper/src/app/api/jobs/[id]/route.ts",nextConfigOutput:"",userland:s}),{workAsyncStorage:g,workUnitAsyncStorage:j,serverHooks:m}=f;function h(){return(0,a.patchFetch)({workAsyncStorage:g,workUnitAsyncStorage:j})}},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},11723:e=>{"use strict";e.exports=require("querystring")},12412:e=>{"use strict";e.exports=require("assert")},28354:e=>{"use strict";e.exports=require("util")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},55511:e=>{"use strict";e.exports=require("crypto")},55591:e=>{"use strict";e.exports=require("https")},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},66541:e=>{"use strict";e.exports=require("@prisma/client/runtime/library")},74075:e=>{"use strict";e.exports=require("zlib")},78335:()=>{},79428:e=>{"use strict";e.exports=require("buffer")},79551:e=>{"use strict";e.exports=require("url")},81630:e=>{"use strict";e.exports=require("http")},94735:e=>{"use strict";e.exports=require("events")},96330:e=>{"use strict";e.exports=require("@prisma/client")},96487:()=>{}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),s=r.X(0,[978,116,190,839],()=>t(7354));module.exports=s})();